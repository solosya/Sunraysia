{{ set(this, 'title', 'My Account') }}


{% set networkData = _Network.getNetworkData() %}
{% set blogData = _Blog.getBlog() %}
{% set propBlogId = blogData.additionalInfo['propertylistingsid'] %}

<!-- Begin User Profile Page -->

{% set propListingsArr = [] %}
{% set pwstats = _User.getPaywallStats(true) %}
{% set plans = _Network.getNetworkData()['paywallPlans'] %}


{% set userLimit = 10 %}
{% set user = _User.getUser() %}



{# {% if user %} 
    {% set userImage = _User.getUserPurchases(user.guid, 0, 10, {'type':"images"}) %}
{% endif %} #}



{% set articleCount = _AppHelper.getApplicationEnv() == 'DEV' ? 0 : 0 %}

<!-- 3 is job, 4 is property, 5 is event -->
{% set dev = _AppHelper.getApplicationEnv() == 'DEV' ? false : false %}

<main id="main" class="o-body-container o-body-container-md u-margin-top-60" role="main">
    <div id="stripekey" class="hidden" >{{_Network.getNetworkData()['stripe_publishable_key']}}</div>

    <div class="container">

        <div class="row">

            <div class="col-12 col-lg-8">

                <div class="row">
                    <div class="col-12 col-md-6">
                        <div class="c-myAccount">
                            {{this.render('layouts/partials/messages.twig') | raw}}



                            <h2 class="c-myAccount__head">My details</h2>
                            
                            
                            {# ERROR TEXT #}
                            <div id="error-container" class="c-form__group has-error" style="display:none">
                                <label class="c-form__label c-account-form__label" for="first-name"></label>
                                <p id="account-form__errorText" class="c-account-form__errorText u-margin-bottom-10"></p>
                            </div>

                            <form id="profile-form" class="c-form" action="#" method="post" autocomplete="off">
                                <input type="hidden" name="_csrf" value="{{_AppHelper.getCsrfToken()}}" />
                                <input type="hidden" name="profileImage" id="userProfileImage" value="" />

                                {# FIRST NAME #}
                                <div class="c-form__group has-error">
                                    <label class="c-form__label c-account-form__label" for="first-name">First name</label>
                                    <input id="first-name" class="c-form__input c-form__input--bordered c-account-form__input" name="firstname" placeholder="First Name" aria-required="true" type="text" value="{{user.firstname}}">
                                    <div class="c-form__help-block">Please enter your first name</div>
                                </div>

                                {# LAST NAME #}
                                <div class="c-form__group u-margin-top-15">
                                    <label class="c-form__label c-account-form__label" for="last-name">Last name</label>
                                    <input id="last-name" class="c-form__input c-form__input--bordered c-account-form__input" name="lastname" placeholder="Last Name" aria-required="true" type="text" value="{{user.lastname}}">
                                    <div class="c-form__help-block"></div>
                                </div>

                                {# EMAIL #}
                                <div class="c-form__group u-margin-top-15">
                                    <label class="c-form__label c-account-form__label" for="email">Email address</label>
                                    <input id="email" class="c-form__input c-form__input--bordered c-account-form__input" name="email" placeholder="Email" aria-required="true" type="text" value="{{user.email}}">
                                    <div class="c-form__help-block"></div>
                                </div>


                                {# Number #}
                                <div class="c-form__group u-margin-top-15">
                                    <label class="c-form__label c-account-form__label" for="organisation">Contact number</label>
                                    <input id="contact-number" class="c-form__input c-form__input--bordered c-account-form__input" name="contact-number"  value="{{user.contactnumber}}" aria-required="true" type="text">
                                    <div class="c-form__help-block"></div>
                                </div>


                                {# PASSWORD #}
                                <div class="c-form__group u-margin-top-15">
                                    <label class="c-form__label c-account-form__label" for="password">Password</label>
                                    <input id="password" class="c-form__input c-form__input--bordered c-account-form__input" name="password" placeholder="Set new password" aria-required="true" type="password">
                                    <div class="c-form__help-block"></div>
                                </div>

                                {# PASSWORD VERIFY #}
                                <div class="c-form__group u-margin-top-15">
                                    <label class="c-form__label c-account-form__label" for="verifypassword">Verify password</label>
                                    <input id="verifypassword" class="c-form__input c-form__input--bordered c-account-form__input" name="verifypassword" placeholder="Verify password" aria-required="true" type="password">
                                    <div class="c-form__help-block"></div>
                                </div>

                                {# ORGANISATION #}
                                
                               

                                {# SUBMIT #}
                                <div class="no-margin-bottom  u-margin-top-20">
                                    <button type="submit" id="" class="c-button c-button--lightgrey c-account-form__update" name="">Update</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="col-12 col-md-6">
                        <div class="c-current-plan">
                            
                            <label class="c-form__label c-account-form__label" for="">Current plan</label>

                            {% if pwstats['type'] == 'time' %}
                                    <div class="c-account-form__static-text">{{pwstats['name']}} at {{pwstats['currency']|replace({"AUD": "$", "NZD": "$", "GBP": "£", "USD": "$", "EUR": "€"})}}{{ pwstats['plan_value']/100}} per {{pwstats['period']}}</div>

                            {% else %} 
                                <div class="c-account-form__static-text">
                                    <span>{{ pwstats['plan_value']/100}}/{{pwstats['total_articles']}}</span>
                                </div>

                                <label class="c-form__label c-account-form__label" for="">Articles Remaining</label>
                                <div class="c-account-form__static-text">
                                    <span>{{ pwstats['article_count']}}</span>
                                </div>
                            {% endif %} 

                            <hr class="divide divide--dark" />


                            {# STATUS #}
                            <div class="c-form__group u-margin-top-15 {% if pwstats['status'] == 'cancelled' %} u-margin-bottom-30 {% endif %}">
                                <label class="c-form__label c-account-form__label" for="">Status</label>

                                <!-- Use this for Paid -->
                                <div class="c-account-form__static-text">
                                    <span class="c-account-form__static-text-{{pwstats['status']}}">{{ pwstats['status'] | capitalize }}</span>
                                {% if pwstats['status'] == 'cancelled' %}
                                        <p class="c-account-form__cancel-msg">Your account will be permanently deleted 30 days after the most recent payment date.</p>
                                {% endif %} 
                                </div>

                            </div>
                                
                            <hr class="divide divide--dark" />

                                {# USERS #}
                                {# <div class="c-form__group u-margin-top-15">
                                    <label class="c-form__label c-account-form__label" for="">Users</label>
                                    <div class="c-account-form__static-text">{{ pwstats['user_count'] }}</div>
                                </div> #}


                            {# NEXT PAYMENT #}
                            {% if pwstats['status'] != 'free' %}
                                <div class="c-form__group no-margin-bottom u-margin-top-15">
                                    <label class="c-form__label c-account-form__label" for="">Next payment</label>
                                    <div class="c-account-form__static-text">{{ pwstats['expiry_date']}}</div>
                                </div>
                            {% endif %} 

                            <hr class="divide divide--dark" />

                            <a id="change-plan" href="#" class="c-button c-button--red">Change Subscription</a>

                            {% if pwstats['status'] == 'cancelled' %}
                                <a id="cancelAccount" href="#" class="c-button c-button--red c-button--red--bordered">Restart Subscription</a>
                            {% else %} 
                                <a id="cancelAccount" href="#" class="c-button c-button--red c-button--red--bordered">Cancel subscription</a>
                            {% endif %} 



                        </div>
                    </div>
                </div>








                {# ****************************************************
                                CHANGE PLANS
                **************************************************** #}

                <div id="plans" class="row u-margin-top-60" style="display:none">
                    <div class="col-12">
                        <h2 class="c-myAccount__head">Change subscription</h2>
                        {% if pwstats['userManager'] == true or pwstats['user_role']['IsSystemAdmin'] %}

                            {% set totalPlanUserCount       = pwstats['user_count'] %}
                            {% set managedUsersObj          = _User.getPaywallManagedUsers({"limit": userLimit}) %}
                            {% set managedUsers             = managedUsersObj %}

                            {% set managedUserCount = managedUsers | length %}
                            {% if managedUsersObj['totalCount'] is defined %}
                                {% set managedUserCount = managedUsersObj['totalCount'] %}
                            {% endif %}


                            <div class="c-plans">
                                {% set break = false %}

                                {% for plan in plans if not break %}
                                    {# {% if pwstats['status'] != 'paid' and pwstats['status'] != 'trial' %} #}
                                    {% set selected = '' %}
                                    {% set userCount = plan.user_count %}
                                    {% set planCost = plan.plan_value / 100 %}
                                    {% if planCost == 19.89 %}
                                        {% set planCost = 19.90 %}
                                    {% endif %}
                                    {% if plan.guid == pwstats['plan_guid'] %}
                                        {% set selected = 'selected' %}
                                    {% endif %}
                                    
                                    <div class="c-plans__block c-plans__block-xs {% if selected == 'selected' %} selected {% else %}  j-setplan {% endif %}">
                                        <span class="c-plans__name c-plans__name--{{ selected }}">{{plan.name}}</span>
                                        {# <span class="c-plans__usercount c-plans__usercount--{{ selected }}">{{userCount}} users</span> #}
                                        <h3 class="c-plans__price">
                                            {{plan.currency|replace({"AUD": "$", "NZD": "$", "GBP": "£", "USD": "$", "EUR": "€"})}}{{planCost|number_format(0, '.', ',')}}<span>p/{{plan.period|replace({"week": "w", "month": "m", "year": "y"})}}</span>
                                        </h3>
                                        <div class="c-plans__description">{{plan.description}}</div>
                                        
                                        {% set buttonClass = selected ? "c-button--red" : "c-button--lightgrey" %}

                                        <a href="javascript:;" class="c-button {{buttonClass}} c-plans__button c-plans__button--{{ selected }}">
                                            {% if selected %} 
                                                Your plan 
                                            {% else %} 
                                                Subscribe 
                                            {% endif %}
                                        </a>
                                        
                                        <input type="hidden" id="planid"        value="{{plan.guid}}">
                                        <input type="hidden" id="planusercount" value="{{userCount}}">
                                        <input type="hidden" id="plancost"      value="{{plan.plan_value}}">
                                        <input type="hidden" id="planperiod"    value="{{plan.period}}">
                                        <input type="hidden" id="currentcost"   value="{{pwstats['plan_value']}}">
                                        <input type="hidden" id="currentperiod" value="{{pwstats['period']}}">
                                        <input type="hidden" id="currentusers"  value="{{managedUserCount}}">
                                        <input type="hidden" id="expdate"       value="{{pwstats['expiry_date']}}">
                                        <input type="hidden" id="_csrf"         value="{{_AppHelper.getCsrfToken()}}"> 
                                    </div>
                                    {# {% set break = true %} #}
                                {% endfor %}

                            </div>
                                
                        {% endif %}

                    </div>
                </div>





                <div class="row u-margin-top-60">
                    <div class="col-12">

                        <form id="update-card-form" action="/update" method="post">
                            <div class="">
                                <h2 class="c-myAccount__head">Change credit card details</h2>

                                <div class="three-column">
                                    <div id="card-element">
                                    <!-- a Stripe Element will be inserted here. -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="">
                                <label class="c-form__label c-account-form__label" for="">Payment method</label>
                                <div class="c-account-form__static-text">credit card/**** **** **** 5261</div>
                            </div>
                            
                            <div class=" no-margin-bottom u-margin-top-15">
                                <button type="submit" id="btnContact" class="c-button c-button--lightgrey" name="contact-button">Update</button>
                            </div>
                        </form>

                    </div>
                 </div>
            </div>
        </div>
    </div>

</main>





<script>
    // main script is defered so event listener makes sure
    // defered script is loaded before this runs
    document.addEventListener("DOMContentLoaded", function(event) {
       



       $("#change-plan").click(function(e) {
            e.preventDefault();
            $("#plans").toggle();
        });


        Acme.userController = new Acme.UserProfileController();

        Acme.userFeed = new Acme.View.articleFeed({
            container       : 'managedUsers',
            offset          : 10,
            limit           : 10,
            model           : Acme.userController,
            name            : 'user-load',
            label           : 'Load more',
            loadtype        : 'user',
            card_class      : 'userdetails',
            cardTemplate    : 'managed_user'
        });




    });
</script>



<!-- //End User Profile Page -->